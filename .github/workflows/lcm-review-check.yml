name: LCM Review Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: read
  checks: write
  contents: read
  members: read

jobs:
  lcm-review-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check LCM review requirement
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            if (!pr) {
              core.setFailed("Not a PR context");
              return;
            }

            const prAuthor = pr.user.login;
            const teamSlug = "lcm";

            // Check if PR author is in LCM
            let authorIsLCM = false;
            try {
              await github.rest.teams.getMembershipForUserInOrg({
                org: owner,
                team_slug: teamSlug,
                username: prAuthor,
              });
              authorIsLCM = true;
            } catch (e) {
              authorIsLCM = false;
            }

            // If author is NOT in LCM, pass immediately
            if (!authorIsLCM) {
              core.notice("PR author is not in LCM — no LCM review required.");
              return;
            }

            // Fetch reviews
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: pr.number,
            });

            // Fetch LCM team members
            const teamMembers = await github.rest.teams.listMembersInOrg({
              org: owner,
              team_slug: teamSlug,
            });

            const lcmMembers = new Set(teamMembers.data.map(m => m.login));

            const hasLCMApproval = reviews.data.some(
              r => r.state === "APPROVED" && lcmMembers.has(r.user.login)
            );

            if (!hasLCMApproval) {
              core.setFailed("PR opened by LCM member — requires approval from another LCM member.");
            } else {
              core.notice("LCM approval detected.");
            }
